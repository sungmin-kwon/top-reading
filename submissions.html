<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Submissions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="/img/topreading.ico" type="image/x-icon" />
  <link rel="stylesheet" href="css/topbar.css" />
  <link rel="stylesheet" href="css/submissions.css" />
  <style>
    body { transition: background 0.3s, color 0.3s; }
    body.dark { background: #121212; color: #e0e0e0; }
    header.topbar { position: sticky; top: 0; z-index: 999; background-color: #333; }
    body.dark header.topbar { background-color: #222; }

    main.container { padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background-color: #eaeaea; }
    body.dark th { background-color: #2c2c2c; color: #f0f0f0; }
    body.dark td { background-color: #1e1e1e; color: #e0e0e0; }

  </style>
</head>
<body>
  <div id="topbar-container"></div>

  <main class="container">
    <h1>üìä My Test Submissions</h1>
    <table id="submissions-table">
      <thead>
        <tr>
          <th data-key="book">Book <span class="sort-indicator"></span></th>
          <th data-key="chapter">
            <span class="label-full">Chapter</span>
            <span class="label-short">Ch.</span>
            <span class="sort-indicator"></span>
          </th>
          <th data-key="score">Score <span class="sort-indicator"></span></th>
          <th data-key="timestamp">Date <span class="sort-indicator"></span></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="status"></p>
    <a href="home.html" id="back-button">‚Üê Back to Home</a>
  </main>

  <!-- Submission Modal -->
  <div id="submission-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="close-modal">&times;</span>
      <div id="modal-summary"></div>
      <div id="modal-questions"></div>
    </div>
  </div>

  <script type="module">
    import { setupTopbar } from "./js/topbar.js";
    import { setupThemeToggleAfterTopbar } from "./js/theme.js";
    setupTopbar("üìä My Submissions");
    setupThemeToggleAfterTopbar();
  </script>

  <script type="module">
    import { auth, db } from "./js/firebase-init.js";
    import {
      collection, query, where, getDocs, getDoc, doc
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";

    const tbody = document.querySelector("#submissions-table tbody");
    const table = document.querySelector("#submissions-table");
    const modal = document.getElementById("submission-modal");
    const closeModal = document.getElementById("close-modal");
    const modalSummary = document.getElementById("modal-summary");
    const modalQuestions = document.getElementById("modal-questions");

    let submissionData = [];

    function renderTable(data) {
      tbody.innerHTML = "";
      data.forEach(({ docId, book, chapter, score, total, timestamp }) => {
        const row = document.createElement("tr");
        const dateStr = timestamp ? timestamp.toDate().toLocaleString() : "Unknown";
        const percentage = ((score / total) * 100).toFixed(1);
        row.innerHTML = `
          <td>${book}</td>
          <td>${chapter}</td>
          <td data-score="${parseFloat(percentage)}">${percentage}%</td>
          <td><a href="#" class="view-submission" data-id="${docId}">${dateStr}</a></td>
        `;
        tbody.appendChild(row);
      });
    }

    function sortTableBy(key, ascending = true) {
      submissionData.sort((a, b) => {
        let valA = a[key], valB = b[key];
        if (key === "timestamp") {
          valA = valA?.toMillis?.() || 0;
          valB = valB?.toMillis?.() || 0;
        }
        if (key === "score") {
          valA = a.score / a.total;
          valB = b.score / b.total;
        }
        return ascending ? valA - valB : valB - valA;
      });
      renderTable(submissionData);
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const q = query(collection(db, "submissions"), where("userId", "==", user.uid));
      const snapshot = await getDocs(q);

      submissionData = snapshot.docs.map(doc => ({
        docId: doc.id,
        ...doc.data()
      }));

      renderTable(submissionData);
    });

    // Sort handler
    let currentSort = {};
    table.querySelectorAll("th[data-key]").forEach(th => {
      th.style.cursor = "pointer";
      th.addEventListener("click", () => {
        const key = th.getAttribute("data-key");
        const ascending = currentSort.key === key ? !currentSort.ascending : true;
        currentSort = { key, ascending };
        sortTableBy(key, ascending);

        // Clear all sort indicators
        document.querySelectorAll(".sort-indicator").forEach(span => span.textContent = "");
        const arrow = ascending ? "‚Üë" : "‚Üì";
        th.querySelector(".sort-indicator").textContent = arrow;
      });
    });

    // Modal open/close
    document.addEventListener("click", async (e) => {
      if (e.target.classList.contains("view-submission")) {
        e.preventDefault();
        const id = e.target.dataset.id;
        const snap = await getDoc(doc(db, "submissions", id));
        if (!snap.exists()) return;

        const data = snap.data();
        const timestamp = data.timestamp?.toDate().toLocaleString() || "Unknown";

        modalSummary.innerHTML = `
          <div><strong>Book:</strong> ${data.book}</div>
          <div><strong>Chapter:</strong> ${data.chapter}</div>
          <div><strong>Score:</strong> ${data.score} / ${data.total}</div>
          <div><strong>Date:</strong> ${timestamp}</div>
        `;

        modalQuestions.innerHTML = "";
        data.answers.forEach((a) => {
          const correct = a.selected === a.correct;
          const q = document.createElement("div");
          q.className = "question " + (correct ? "correct" : "wrong");
          q.innerHTML = `
            <p><strong>Q${a.number}:</strong> ${a.question}</p>
            <p><strong>Your Answer:</strong> ${a.selected}</p>
            <p><strong>Correct Answer:</strong> ${a.correct}</p>
          `;
          modalQuestions.appendChild(q);
        });

        modal.style.display = "block";
      }
    });

    closeModal.onclick = () => modal.style.display = "none";
    window.onclick = (e) => {
      if (e.target === modal) modal.style.display = "none";
    };
  </script>
</body>
</html>
